FROM ubuntu:22.04
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Tokyo
ENV LANG C.UTF-8
ENV LANGUAGE en_US
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Install necessary packages
RUN apt update && apt upgrade -y
RUN apt install -y software-properties-common && add-apt-repository ppa:deadsnakes/ppa
RUN apt -y install \
        clamav \
        clamav-daemon \
        curl \
        sudo \
        dnsutils \
        iproute2 \
        iptables \
        iputils-ping \
        libssl-dev \
        net-tools \
        tcpdump \
        nmap \
        nasm \
        python3.11 \
        golang \
        gcc \
        git \
        emacs \
        nano \
        vim \
        ssh

# For Chapter02
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11
RUN pip3 install \
    cffi \
    scapy \
    cryptography \
    ipython

# For Chapter05
# Also required for gem install
RUN curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
    chmod 755 msfinstall && \
    ./msfinstall
ENV PATH $PATH:/opt/metasploit-framework/embedded/bin

# For Chapter03
RUN gem install ruby-nmap

RUN useradd -m -s /bin/bash pentester \
    && usermod -aG sudo pentester \
    && echo "root:pentest" | chpasswd \
    && echo "pentester:pentest" | chpasswd

RUN echo "alias sudo='sudo '" >> ~/.bashrc
RUN echo "alias python='python3.11'" >> ~/.bashrc
RUN cp /root/.bashrc /home/pentester/.bashrc

# For Chapter05
RUN /etc/init.d/clamav-freshclam start
RUN /etc/init.d/clamav-daemon start

# For Chapter06
RUN echo "" >> /home/pentester/.vimrc
RUN mkdir -p /home/pentester/.vim/plugin
RUN mkdir /home/pentester/.ssh

COPY ./pentester/code /home/pentester/code
RUN chown -R pentester /home/pentester

USER pentester
WORKDIR /home/pentester

RUN git clone https://github.com/danielmiessler/SecLists.git /home/pentester/SecLists